---
title: "WINGMEN GSEA plots"
author: "Fiona Hartley"
date: '`r format(Sys.Date(), "%Y-%B-%d")`'
output: 
  html_document:
    toc: true
    toc_depth: 5
    toc_float: true
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
options(stringsAsFactors = FALSE)

```

# Set directories
Set the data directory as the folder where you have stored the data I've sent to you. It's probably easier to keep all of these in one place then you don't have to keep changing the code. I use the file names I gave to each of the objects to load them in, so if you changed the file names of anything I sent to you, you'll have to go through and change those within the code too.

You should set the results directory to a folder where you want to store any plots produced.

```{r set_directories}

data_directory <- "C:/Users/fhartley/Desktop/data"
res_directory <- "C:/Users/fhartley/Desktop/plots"

```

# Load packages

```{r load_packages, echo=FALSE, message=FALSE, warning=FALSE}

# Graphics
library(ggplot2)
library(enrichplot)

# Other
library(dplyr)
library(tidyverse)

```

# Set up custom functions
Run this but don't edit anything

```{r functions, echo=FALSE, message=FALSE, warning=FALSE}

label_fun <- function(n){
  
  function(x, width = n){
    x = label_fun_def(x)
    ep_str_wrap(string = x, width = width)
  }
}

label_fun_def <- function(
  x
  ){
  x = gsub(pattern = "^GOBP_",     replacement = "", x = x, fixed = F)
  x = gsub(pattern = "^KEGG_",     replacement = "", x = x, fixed = F)
  x = gsub(pattern = "^BIOCARTA_", replacement = "", x = x, fixed = F)
  x = gsub(pattern = "^REACTOME_", replacement = "", x = x, fixed = F)
  x = gsub(pattern = "^WP_",       replacement = "", x = x, fixed = F)
  x = gsub(pattern = "^HALLMARK_", replacement = "", x = x, fixed = F)

  # Remove underscores
  x = gsub(pattern = "_", replacement = " ", x = x)  
  
  #return
  return(x)
}

ep_str_wrap <- function (string, width = getOption("width")) 
{
    result <- vapply(string, FUN = function(st) {
        words <- list()
        i <- 1
        while (nchar(st) > width) {
            if (length(grep(" ", st)) == 0) 
                break
            y <- gregexpr(" ", st)[[1]]
            n <- nchar(st)
            y <- c(y, n)
            idx <- which(y < width)
            if (length(idx) == 0) 
                idx <- 1
            words[[i]] <- substring(st, 1, y[idx[length(idx)]] - 
                1)
            st <- substring(st, y[idx[length(idx)]] + 1, n)
            i <- i + 1
        }
        words[[i]] <- st
        paste0(unlist(words), collapse = "\n")
    }, FUN.VALUE = character(1))
    names(result) <- NULL
    result
}

dotplot2 <- function (
    object, 
    x = "geneRatio", 
    color = "p.adjust", 
    showCategory = 10, 
    size = NULL, 
    split = NULL, 
    title = "", 
    orderBy = "x", 
    label_format = 30, 
    decreasing = TRUE) 
{
  colorBy <- match.arg(color, c("pvalue", "p.adjust", "qvalue"))
  if(color == "pvalue"){
    legend.name <- expression(italic(p)~'value')
  }
  if(color == "p.adjust"){
    legend.name <- expression("Adjusted"~italic(p)~"value")
  }
  if(color == "qvalue"){
    legend.name <- expression(italic(q)~'value')
  }
  if (x == "geneRatio" || x == "GeneRatio") {
    x <- "GeneRatio"
    if (is.null(size)) 
      size <- "Count"
  }
  else if (x == "count" || x == "Count") {
    x <- "Count"
    if (is.null(size)) 
      size <- "GeneRatio"
  }
  else if (is(x, "formula")) {
    x <- as.character(x)[2]
    if (is.null(size)) 
      size <- "Count"
  }
  else {
    if (is.null(size)) 
      size <- "Count"
  }
  if (inherits(object, c("enrichResultList", "gseaResultList"))) {
    ldf <- lapply(object, fortify, showCategory = showCategory, 
                  split = split)
    df <- dplyr::bind_rows(ldf, .id = "category")
    df$category <- factor(df$category, levels = names(object))
  }
  else {
    df <- fortify(object, showCategory = showCategory, split = split)
  }
  if (orderBy != "x" && !orderBy %in% colnames(df)) {
    message("wrong orderBy parameter; set to default `orderBy = \"x\"`")
    orderBy <- "x"
  }
  if (orderBy == "x") {
    df <- dplyr::mutate(df, x = eval(parse(text = x)))
  }
  label_func <- enrichplot:::default_labeller(label_format)
  if (is.function(label_format)) {
    label_func <- label_format
  }
  idx <- order(df[[orderBy]], decreasing = decreasing)
  df$Description <- factor(df$Description, levels = rev(unique(df$Description[idx])))
  ggplot2::ggplot(
    data = df, 
    aes_string(x = x, y = "Description", size = size, color = colorBy)
  ) + 
    ggplot2::geom_point() + 
     scale_color_continuous(
       low = "red", 
       high = "blue", 
       name = legend.name, 
       guide = guide_colorbar(reverse = TRUE)
     ) + 
   # ggplot2::scale_colour_stepsn(
    #  colours = c("#67000D", "#CB181D","#EF3B2C","#FB6A4A", "#FCBBA1","#2171B5", "#08519C", "#08306B"),
     # limits = c(0,1),
      #breaks = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 0.25, 0.5, 1),
      #values = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 0.25, 0.5, 1)
    #) + 
    ggplot2::scale_y_discrete(labels = label_func) + 
    ggplot2::ylab(NULL) + 
    ggplot2::ggtitle(title) + 
    DOSE:::theme_dose() + 
    ggplot2::scale_size(range = c(3, 8)) +
    ggplot2::guides(size = ggplot2::guide_legend(order = 1))+
    theme(
    axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
    axis.title.x = element_text(colour = "black", size = 12),
    axis.title.y = element_text(colour = "black", size = 12),
    axis.text.y = element_text(color = "black", size = 8),
    axis.text.x = element_text(color = "black", size = 10),
    plot.title = element_text(hjust = 0.5),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_line(color = "transparent"),
    strip.background = element_rect(fill = "transparent", color = "transparent"),
    strip.text = element_text(color = "black", face = "bold"))
}

  

```

# Gene Set Enrichment Analysis (GSEA)
GSEA aggregates the statistics for each gene within a gene set (e.g. each gene within a particular pathway), making it possible to detect situations where genes in a predefined set change in a coordinated way. The goal of GSEA is to determine whether the members of a geneset are randomly distributed throughout the ranked gene list or primarily found at the top or bottom. The ranked gene list is typically obtained through ranking genes based on their log2 fold change. In our case, we combined both the p value and the log2 fold change (log2FC * -log10(pvalue)) to create a score upon which to rank the genes.

There are three key elements of the GSEA method:

* Calculation of an Enrichment Score.
  + The enrichment score (*ES*) represents the degree to which a geneset is over-represented at the top or bottom of the ranked list. The score is calculated by walking down the list, increasing a running-sum statistic when we encounter a gene in the geneset and decreasing when it is not encountered. The *ES* is the maximum deviation from zero encountered in the random walk; it corresponds to a weighted Kolmogorov-Smirnov(KS)-like statistic (Subramanian et al. 2005).

* Estimation of Significance Level of *ES*.
  + The p-value of the *ES* is calculated using a permutation test. Specifically, we permute the genes in the gene list and recompute the ES of the gene set for the permutated (i.e. random) data. This generates a null distribution for the *ES*. The p-value of the observed ES is then calculated relative to this null distribution.
  
* Adjustment for Multiple Hypothesis Testing.
  + When the many genesets are evaluated, the estimated significance level is adjusted to account for multiple hypothesis testing.

In this guide, we will make two types of plot to represent GSEA data: dotplots and heatmaps.

# Load the ORA results object.
This is a list of ORA results, with each list entry containing results of a different database.

```{r load_ora_results}

ora_res <- readRDS(file = file.path(data_directory, "ora_fasting_results.rds"))

```

# Choose the database you would like to show the results for.
1. Gene Ontology Biological Processes
2. KEGG terms
3. Biocarta
4. Reactome
5. Wikipathways
6. Hallmarks

```{r database}

# First choose the database you would like to display results for. You can choose a number 1-6 as shown in the description above (i.e. to show results from Reactome, type 4)
database <- 1

# Subset the results for the chosen database
x <- ora_res[[database]]

```

# Create a dotplot of the top results
Use this code to generate a dotplot that displays the most significant results from your chosen database. 

You can choose to display the top results regardless of whether the adjusted p value is actually significant (in some case there are no results < 0.05, so the plot will just show whichever pathways have the lowest value), or you can add a filter so that only results meeting a certain cutoff will be displayed.

If there aren't significant results in both activated and suppressed pathways, the side of the plot without results will be automatically removed.

```{r top_results_dotplot}

# Add a filter so that only significant results are displayed. Set this value to 1 to keep all results.
x@result <- x@result[x@result$p.adjust <= 0.05,] 

# Create the dotplot
p <- print(dotplot2(
  object       = x,
  x            = "GeneRatio",
  showCategory = 25, # How many pathways you want to show on the y axis. Play around with this number.
  title        = "Xentuzumab Treatment", # Change this as you wish, or set to NULL to remove the title altogether
    orderBy      = "x",
    color        = "p.adjust", # You can also show pvalue or qvalue, but I'd recommend leaving as p.adjust. If you do change it, you'll need to change the filter step above to match.
    label_format = label_fun(n = 30), # How many characters a pathway name can be before it spills on to a new line. Play around with this number to see what looks best for your pathways.
    decreasing   = TRUE
  )
  )

# Show the plot
p

# Save the plot
ggsave(filename = "dotplot_topresults.png", # Type your chosen file name here
       plot = p,
       device = png, # The saved image type. Other formats are available, see: https://ggplot2.tidyverse.org/reference/ggsave.html
       width = 20,   # Change the plot size by adjusting width
       height = 15,  # Change the plot size by adjusting height
       units = "cm", # I have used cm, but other units of measure are available, see link above
       path = res_directory)

```

# Create a dotplot of selected results
You can also choose to display only specific pathways. This can be helpful as it allows you to remove pathways that are very similar, or ones that aren't relevant to us.

```{r selected_res_dotplots}

# Investigate the pathways that are available for you to choose. Note that if you filtered for adjusted p value in the previous section, that filtering will still be in place here. If you want to see all unfiltered pathways, reset the object by re-running the "Choose the database you would like to show the results for" chunk.
view(x@result)

# Create a vector of the pathways you would like to display. This list can be as long or as short as you like. Here are some examples of ones from the report.
selected_pathways <- c(
  "HALLMARK_TNFA_SIGNALING_VIA_NFKB", 
  "HALLMARK_HYPOXIA", 
  "HALLMARK_INFLAMMATORY_RESPONSE", 
  "HALLMARK_IL2_STAT5_SIGNALING", 
  "HALLMARK_ESTROGEN_RESPONSE_EARLY", 
  "HALLMARK_TGF_BETA_SIGNALING", 
  "HALLMARK_UV_RESPONSE_DN", 
  "HALLMARK_INTERFERON_GAMMA_RESPONSE"
  )

selected_pathways <- c(
  "GOBP_REGULATION_OF_INFLAMMATORY_RESPONSE", 
  "GOBP_ACUTE_INFLAMMATORY_RESPONSE", 
  "GOBP_LEUKOCYTE_CHEMOTAXIS", 
  "GOBP_CELL_CHEMOTAXIS", 
  "GOBP_T_CELL_DIFFERENTIATION", 
  "GOBP_T_CELL_ACTIVATION", 
  "GOBP_MYELOID_LEUKOCYTE_ACTIVATION", 
  "GOBP_LEUKOCYTE_DIFFERENTIATION",
  "GOBP_INTERLEUKIN_1_MEDIATED_SIGNALING_PATHWAY",
  "GOBP_LEUKOCYTE_MIGRATION",
  "GOBP_RESPONSE_TO_WOUNDING"
  )

selected_pathways <- c(
  "REACTOME_SIGNALING_BY_INTERLEUKINS", 
  "REACTOME_INTERLEUKIN_4_AND_INTERLEUKIN_13_SIGNALING", 
  "REACTOME_INTERLEUKIN_1_SIGNALING", 
  "REACTOME_INTERLEUKIN_10_SIGNALING", 
  "REACTOME_INTERLEUKIN_6_SIGNALING", 
  "REACTOME_TOLL_LIKE_RECEPTOR_CASCADES", 
  "REACTOME_CELLULAR_SENESCENCE", 
  "REACTOME_SENESCENCE_ASSOCIATED_SECRETORY_PHENOTYPE_SASP",
  "REACTOME_ESR_MEDIATED_SIGNALING", 
  "REACTOME_MAPK1_ERK2_ACTIVATION", 
  "REACTOME_MAPK_FAMILY_SIGNALING_CASCADES",
  "REACTOME_DEGRADATION_OF_THE_EXTRACELLULAR_MATRIX",
  "REACTOME_ACTIVATION_OF_THE_AP_1_FAMILY_OF_TRANSCRIPTION_FACTORS"
  )

# Create the dotplot
p1 <- print(dotplot2(
  object       = x,
  x            = "GeneRatio",
  showCategory = selected_pathways,
  title        = "Xentuzumab Treatment", # Change this as you wish, or set to NULL to remove the title altogether
    orderBy      = "x",
    color        = "p.adjust", # You can also show pvalue or qvalue, but I'd recommend leaving as p.adjust. If you do change it, you'll need to change the filter step above to match.
    label_format = label_fun(n = 30), # How many characters a pathway name can be before it spills on to a new line. Play around with this number to see what looks best for your pathways.
    decreasing   = TRUE
  ))

# Show the plot
p1
p1$labels$title <- NULL

# Save the plot
ggsave(filename = "dotplot_fasting_ora.png", # Type your chosen file name here
       plot = p1,
       device = png, # The saved image type. Other formats are available, see: https://ggplot2.tidyverse.org/reference/ggsave.html
       width = 18,   # Change the plot size by adjusting width
       height = 15,  # Change the plot size by adjusting height
       units = "cm", # I have used cm, but other units of measure are available, see link above
       path = res_directory,
       dpi = 1200)

```

Optional: the upper/lower case lettering for the pathway names generally isn't very good (e.g. gene names aren't capitalised where they should be). You can fix this manually, but it is very time consuming. I wouldn't bother doing this unless you are preparing a figure for publication.

```{r selected_res_dotplots2}

# Create your plot using the code above first. 

# Adjust the pathway names as desired.
# Note that the automatic line splitting no longer works, so you have to manually add line breaks when you want a pathway name to spill over multiple lines. Use \n to start a new line. 
p1 <- p1+
  scale_y_discrete(labels = c(
  "REACTOME_SIGNALING_BY_INTERLEUKINS" = 
    "Signalling by Interleukins", 
  "REACTOME_ESR_MEDIATED_SIGNALING" = 
    "ESR Mediated Signaling", 
  "REACTOME_INTERLEUKIN_4_AND_INTERLEUKIN_13_SIGNALING" =
    "Interleukin 4 and \nInterleukin 13 Signalling", 
  "REACTOME_CELLULAR_SENESCENCE" = 
    "Cellular Senescence", 
  "REACTOME_SENESCENCE_ASSOCIATED_SECRETORY_PHENOTYPE_SASP" =
    "Senescence Associated \nSecretory Phenotype",
  "REACTOME_INTERLEUKIN_1_SIGNALING" =
    "Interleukin 1 Signalling", 
  "REACTOME_INTERLEUKIN_10_SIGNALING" =
    "Interleukin 10 Signalling", 
  "REACTOME_MAPK1_ERK2_ACTIVATION" =
    "MAPK1 ERK2 Activation", 
  "REACTOME_TOLL_LIKE_RECEPTOR_CASCADES" =
    "Toll-like Receptor \nCascades", 
  "REACTOME_INTERLEUKIN_6_SIGNALING" =
    "Interleukin 6 Signalling", 
  "REACTOME_MAPK_FAMILY_SIGNALING_CASCADES" =
    "MAPK Family \nSignalling Cascades", 
  "REACTOME_DEGRADATION_OF_THE_EXTRACELLULAR_MATRIX" =
    "Degradation of \nExtraceullular Matrix",
  "REACTOME_ACTIVATION_OF_THE_AP_1_FAMILY_OF_TRANSCRIPTION_FACTORS" =
    "Activation of AP-1 \nTranscription Factors"
  ))

# View the plot
p1

# Prepare for publication
p1$labels$title <- NULL


# Save the plot
ggsave(filename = "dotplot_selectedpathways_reactome.png", # Type your chosen file name here
       plot = p1,
       device = png, # The saved image type. Other formats are available, see: https://ggplot2.tidyverse.org/reference/ggsave.html
       width = 15,   # Change the plot size by adjusting width
       height = 15,  # Change the plot size by adjusting height
       units = "cm", # I have used cm, but other units of measure are available, see link above
       dpi = 1200,
       path = res_directory)

```

# Create a heatmap of the genes that are driving the pathway enrichment
As with the dotplots, you can either choose to just display the top results, or you can type out specific pathways you would like to include. I think selected pathways makes more sense for this type of plot, but I've included both just in case.

First, we create heatmaps of the top results.

```{r heatplot_top_results}

# Read in the log fold changes for the genes
logFC <- readRDS(file = file.path(data_directory, "logFC.rds"))

# Add a filter so that only significant results are displayed. Set this value to 1 to keep all results.
x@result <- x@result[x@result$p.adjust <= 0.1,] 

p2 <- heatplot(
  x = x, 
  showCategory = 6, # How many pathways you want to show
  foldChange = logFC, 
  label_format = label_fun(n = 30))+ # How many characters a pathway name can be before it spills on to a new line. Play around with this number to see what looks best for your pathways.
  viridis::scale_fill_viridis()+
  #coord_flip()+ # Delete the # to flip the axes and make the heatmap horizontal. When doing this, you may need to adjust the axes font sizes above. You will also have to change the height and width options when saving the plot.
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 3), # Size changes the font size for the x axis
        axis.text.y = element_text(size = 6), # Size changes the font size for the y axis
        legend.title.position = "right",
        legend.title = element_text(vjust = 0.75, size = 6),
        legend.text = element_text(size = 8),
        legend.position = "bottom") 

p2$labels$fill <- expression("Log"[2]*" Fold Change")

# View the plot
p2

# Save the plot
ggsave(filename = "heatplot_topresults.png", # Type your chosen file name here
       plot = p2,
       device = png, # The saved image type. Other formats are available, see: https://ggplot2.tidyverse.org/reference/ggsave.html
       width = 30,   # Change the plot size by adjusting width
       height = 7,  # Change the plot size by adjusting height
       units = "cm", # I have used cm, but other units of measure are available, see link above
       path = res_directory)

```

# Create a heatmap of the genes that are driving the enrichment of selected pathways

```{r heatplot_selected_results}

# Read in the log fold changes for the genes
logFC <- readRDS(file = file.path(data_directory, "logFC.rds"))

# Investigate the pathways that are available for you to choose. Note that if you filtered for adjusted p value previously, that filtering will still be in place here. If you want to see all unfiltered pathways, reset the object by re-running the "Choose the database you would like to show the results for" chunk.
view(x@result)

# Create a vector of the pathways you would like to display. Although this list can be as long as you like, the heatmap and number of genes can get very big very quickly, so generally you should try to be more selective with your pathway choices here. 
selected_pathways <- c(
  "HALLMARK_TNFA_SIGNALING_VIA_NFKB", 
  "HALLMARK_HYPOXIA", 
  "HALLMARK_INFLAMMATORY_RESPONSE", 
  "HALLMARK_IL2_STAT5_SIGNALING", 
  "HALLMARK_ESTROGEN_RESPONSE_EARLY", 
  "HALLMARK_TGF_BETA_SIGNALING", 
  "HALLMARK_UV_RESPONSE_DN", 
  "HALLMARK_INTERFERON_GAMMA_RESPONSE"
  )

selected_pathways <- c(
  "REACTOME_SIGNALING_BY_INTERLEUKINS", 
  "REACTOME_INTERLEUKIN_4_AND_INTERLEUKIN_13_SIGNALING", 
  "REACTOME_INTERLEUKIN_1_SIGNALING", 
  "REACTOME_INTERLEUKIN_10_SIGNALING", 
  "REACTOME_INTERLEUKIN_6_SIGNALING", 
  "REACTOME_CELLULAR_SENESCENCE", 
  "REACTOME_SENESCENCE_ASSOCIATED_SECRETORY_PHENOTYPE_SASP"
  )

selected_pathways <- c(
  "REACTOME_CELLULAR_SENESCENCE", 
  "REACTOME_SENESCENCE_ASSOCIATED_SECRETORY_PHENOTYPE_SASP"
  )

selected_pathways <- c(
  "GOBP_T_CELL_ACTIVATION",
  "GOBP_T_CELL_DIFFERENTIATION"
  )

selected_pathways <- c(
  "GOBP_REGULATION_OF_INFLAMMATORY_RESPONSE",
  "GOBP_ACUTE_INFLAMMATORY_RESPONSE",
  "GOBP_POSITIVE_REGULATION_OF_INFLAMMATORY_RESPONSE"
  )

selected_pathways <- c(
  "GOBP_LEUKOCYTE_CHEMOTAXIS",
  "GOBP_CELL_CHEMOTAXIS",
  "GOBP_TAXIS",
  "GOBP_REGULATION_OF_LEUKOCYTE_CHEMOTAXIS",
  "GOBP_GRANULOCYTE_CHEMOTAXIS",
  "GOBP_NEUTROPHIL_CHEMOTAXIS",
  "GOBP_REGULATION_OF_CHEMOTAXIS",
  "GOBP_POSITIVE_REGULATION_OF_CYTOKINE_PRODUCTION"
  )



p3 <- heatplot(
  x = x, 
  showCategory = selected_pathways, 
  foldChange = logFC, 
  label_format = label_fun(n = 30))+ 
  viridis::scale_fill_viridis()+
  #coord_flip()+ # Delete the # to flip the axes and make the heatmap horizontal. When doing this, you may need to adjust the axes font sizes above. You will also have to change the height and width options when saving the plot.
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 3), # Size changes the font size for the x axis
        axis.text.y = element_text(size = 6), # Size changes the font size for the y axis
        legend.title.position = "right",
        legend.title = element_text(vjust = 0.75, size = 8),
        legend.text = element_text(size =8),
        legend.position = "bottom")

p3$labels$fill <- expression("Log"[2]*" Fold Change")

# View the plot
p3

# Save the plot
ggsave(filename = "heatplot_senescence.png", # Type your chosen file name here
       plot = p3,
       device = png, # The saved image type. Other formats are available, see: https://ggplot2.tidyverse.org/reference/ggsave.html
       width = 22,   # Change the plot size by adjusting width
       height = 4,  # Change the plot size by adjusting height
       units = "cm", # I have used cm, but other units of measure are available, see link above
       dpi = 1200,
       path = res_directory)


```

Optional: the pathway names are by default all caps. You can fix this manually, but it is very time consuming. I wouldn't bother doing this unless you are preparing a figure for publication.

```{r}

# Create your plot using the code above first. 

# Adjust the pathway names as desired.
# Note that the automatic line splitting no longer works, so you have to manually add line breaks when you want a pathway name to spill over multiple lines. Use \n to start a new line. 
p3 <- p3+
  scale_y_discrete(labels = c(
  "REACTOME_SIGNALING_BY_INTERLEUKINS" = 
    "Signalling by Interleukins", 
  "REACTOME_INTERLEUKIN_4_AND_INTERLEUKIN_13_SIGNALING" =
    "Interleukin 4 and \nInterleukin 13 Signalling", 
  "REACTOME_CELLULAR_SENESCENCE" = 
    "Cellular Senescence", 
  "REACTOME_SENESCENCE_ASSOCIATED_SECRETORY_PHENOTYPE_SASP" =
    "Senescence Associated \nSecretory Phenotype",
  "REACTOME_INTERLEUKIN_1_SIGNALING" =
    "Interleukin 1 Signalling", 
  "REACTOME_INTERLEUKIN_10_SIGNALING" =
    "Interleukin 10 Signalling", 
  "REACTOME_INTERLEUKIN_6_SIGNALING" =
    "Interleukin 6 Signalling"
  ))

# View the plot
p3

# Save the plot
ggsave(filename = "heatplot_selectedpathways.png", # Type your chosen file name here
       plot = p3,
       device = png, # The saved image type. Other formats are available, see: https://ggplot2.tidyverse.org/reference/ggsave.html
       width = 22,   # Change the plot size by adjusting width
       height = 7,  # Change the plot size by adjusting height
       units = "cm", # I have used cm, but other units of measure are available, see link above
       path = res_directory)


```

